# LORENZ SaaS - Docker Compose Production
# Deploy with: docker compose -f docker-compose.prod.yml up -d
# Note: Uses existing infrastructure (Redis, PostgreSQL, Qdrant) on host

version: '3.8'

services:
  # Frontend (Next.js)
  frontend:
    build:
      context: ./lorenz-web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://lorenz.bibop.com/api}
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    container_name: lorenz-frontend
    restart: unless-stopped
    ports:
      - "3050:3000"
    environment:
      - NODE_ENV=production
    networks:
      - lorenz-network
    depends_on:
      - backend

  # Backend (FastAPI)
  backend:
    build:
      context: ./lorenz-backend
      dockerfile: Dockerfile
    container_name: lorenz-backend
    restart: unless-stopped
    ports:
      - "8050:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://lorenz:lorenz@host.docker.internal:5433/lorenz
      - REDIS_URL=redis://host.docker.internal:6379
      - QDRANT_HOST=host.docker.internal
      - QDRANT_PORT=6333
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=https://lorenz.bibop.com,https://dev.lorenz.bibop.com
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - lorenz-network

networks:
  lorenz-network:
    driver: bridge
